# ACIT 2420 Assignment 3 Part 1

## Webgen Setup Instructions
The webgen system will create the following directory structure:
```
/var/lib/webgen/
├── bin/
│   └── generate_index
└── HTML/
    └── index.html
```

- The `generate_index` script will need to be moved into `/var/lib/webgen/bin/` (to be seen later) to generates the HTML.
- The `HTML` directory contains the `index.html` file (generated by `generate_index`), which is served by `nginx`.

## Creating the System User

To enhance security and prevent accidental system changes, the `webgen` user is created to run the script instead of using a regular user or root. Using a system user minimizes the risk of security vulnerabilities and ensures that only the required permissions will be granted.
```bash
sudo useradd -r -s /bin/bash webgen
```
## Setting Up Directories and Permissions
- You will need to create the directories:
```bash
sudo mkdir -p /var/lib/webgen/bin
sudo mkdir -p /var/lib/webgen/HTML
```
- The webgen user needs the proper permissions to read/write to the bin and HTML directories. 

```bash
sudo chown -R webgen:webgen /var/lib/webgen
sudo chmod u=rwx,g=rx,o= /var/lib/webgen /var/lib/webgen/HTML
```

## Moving the `generate_index` Script
- The generate_index script should be placed in /var/lib/webgen/bin/. This script generates system information in HTML.

- Using sftp you can transfer the file from your local machine:
```bash
put path/to/generate_index
```
- Then you can move it to `/var/lib/webgen/bin/` using:
```bash
sudo mv generate_index /var/lib/webgen/bin/
```
- You will need to give it the correct ownership and permissions:
```bash
sudo chown webgen:webgen /var/lib/webgen/bin/generate_index
sudo chmod +x /var/lib/webgen/bin/generate_index
```

## The `systemd` Service and Timer
To automate the generation of the `index.html` file, we use `systemd` timers. The generate_index service is triggered by a timer that runs daily.

- Using sftp you can transfer the service and timer files from your local machine:
```bash
put /path/to/generate-index.service 
put /path/to/generate-index.timer
```
-Then move them into the correct directories:
```bash
sudo mv generate-index.service /etc/systemd/system/
sudo mv generate-index.timer /etc/systemd/system/
```
- Now you can enable and start the timer:
```bash
sudo systemctl daemon-reload
sudo systemctl enable --now generate-index.timer
```
- Make sure to verify that the timer is actice and that the service runs successfully:
```bash
sudo systemctl status generate-index.timer
sudo systemctl status generate-index.service
```
## Configuring `nginx`
Separating the server block file for the `webgen` service rather than modifying the `nginx.conf` file directly makes it easier to manage configurations.

- You will need to create the direcory for server block configurations if they don't exist:
```bash
sudo mkdir -p /etc/nginx/sites-available
sudo mkdir -p /etc/nginx/sites-enabled
```
- Using sftp you can nginx configuration and server block files from your local machine:
```bash
put /path/to/nginx.conf
put /path/to/webgen
```
- Then move them to the correct directories:
```bash
sudo mv nginx.conf /etc/nginx/
sudo mv webgen /etc/nginx/sites-available
```
- You can now enable the site by creating a symlink:
```bash
sudo ln -s /etc/nginx/sites-available/webgen /etc/nginx/sites-enabled/
```
- Once that's done, you will need to reload `nginx`:
```bash
sudo systemctl reload nginx
```
- You can also check the status of `nginx` to make sure it is running as expected:
```bash
sudo systemctl status nginx
```
- You can also test the `nginx` configuration by using the following:
```bash
sudo nginx -t
```
## Configuring UFW
Make sure to install `ufw` or update your server if you haven't recently:
```bash
sudo pacman -S ufw
```
- Now you can configure `ufw` using the following commands: 
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow http
sudo ufw limit shh
sudo systemctl enable --now ufw.service
```
- Once you have done that you can enable `ufw`:
```bash
sudo ufw enable
```
- To check the status you can use:
```bash
sudo ufw status verbose
```

## Enhancing the `generate_index` Script
1. Adding a check to ensure that the script receives exactly one argument
```bash
if [ "$#" -ne 1 ]; then
    echo "Error: Exactly one output directory argument is required."
    echo "Try: $0 <output-directory>"
    exit 1
fi
```
If no arguments or more than one is provided, the script will display an error message and exit. This prevents further execution with invalid input. This helps to avoid unexpected behavior like using an undefined or incorrect directory.
**Reference:https://unix.stackexchange.com/questions/506719/taking-input-in-a-script-and-making-sure-theres-only-one-parameter**

2. Disk Usage
**Initial Attempt:**
```bash
DISK_USAGE=$(df -h / | awk 'NR==1 {print $3 " used out of " $2}')
```
The line was incorrectly retrieving the first row (NR==1) from the `df` output, giving me the header instead of the actual disk usage information. This resulted in unwanted output. I changed the `NR==1` to `NR==2` in the `awk` command to then get the correct line.

```bash
DISK_USAGE=$(df -h / | awk 'NR==2 {print $3 " used out of " $2}')
```
**Reference:man fd, and man awk**

3. Memory Usage
**Initial Attempt:**
```bash
MEMORY_USAGE=$(free -h | awk '/^Memory/ {print $3 " used out of " $2}')
```
The regular expression `/^Memory/` did not match anything because the actual output of the `free` command uses `Mem:` instead of `Memory`. This resulted in no output from the awk command. I changed the regular expression to `/^Mem:/` to match the correct line in the output of the `free` command.

```bash
MEMORY_USAGE=$(free -h | awk '/^Mem:/ {print $3 " used out of " $2}')
```
**Reference:man free, and man awk**